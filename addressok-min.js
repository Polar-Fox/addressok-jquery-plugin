// addressok.js
// jQuery-плагин для AddressOK.
// v0.1.0
// 2016-11-04
// (c) 2016 Ильдар Ахмадуллин
!function(e){jQuery.fn.AddressOK=function(t){return this.each(function(){function a(){b={zip_code:p.val(),region:v.val(),district:k.val(),place:h.val(),street:y.val()}}function r(){return b.zip_code!=p.val()||b.region!=v.val()||b.district!=k.val()||b.place!=h.val()||b.street!=y.val()?!0:!1}function s(e){e.data("addressok-aoid",0),e.data("addressok-label",""),e.val("")}function d(e,t){void 0!=t&&""!=t.label&&(e.val(t.label),e.data("addressok-aoid",t.value),e.data("addressok-label",t.label))}function o(e,t){e.autocomplete({source:t,minLength:0,delay:0,focus:function(t,a){return e.val(a.item.label),!1},select:function(t,a){return e.val(a.item.label),e.data("addressok-aoid",a.item.value),e.data("addressok-label",a.item.label),!1}})}function i(){b={zip_code:"",region:"",district:"",place:"",street:""},s(p),s(v),s(k),s(h),s(y)}function l(e){p.val(e.fill.zip),d(v,e.fill.region),d(k,e.fill.district),d(h,e.fill.place),d(y,e.fill.street),o(v,e.suggest.region),o(k,e.suggest.district),o(h,e.suggest.place),o(y,e.suggest.street),a()}function n(){var t=p.val();if(""!=t){var a={request_type:"zip",zip_code:t};e.ajax({type:"POST",url:g.data("addressok-server-url"),data:a,dataType:"json",success:function(e){l(e)},error:function(e,t,a){console.log("AddressOK: Error: Could not get address data. Error message: "+a)}})}}function u(e){return e.data("addressok-label")==e.val()?e.data("addressok-aoid"):0}function c(){var t=p.val(),a=u(v),r=u(k),s=u(h),d=u(y),o={request_type:"all",zip_code:t,region_id:a,district_id:r,place_id:s,street_id:d};e.ajax({type:"POST",url:g.data("addressok-server-url"),data:o,dataType:"json",success:function(e){l(e)},error:function(e,t,a){console.log("AddressOK: Error: Could not get address data. Error message: "+a)}})}function f(e){e?n():c()}var g=e(this),p=e(this).find('input[type="text"][data-addressok-field="zip"]').eq(0),v=e(this).find('input[type="text"][data-addressok-field="region"]').eq(0),k=e(this).find('input[type="text"][data-addressok-field="district"]').eq(0),h=e(this).find('input[type="text"][data-addressok-field="place"]').eq(0),y=e(this).find('input[type="text"][data-addressok-field="street"]').eq(0),_=!0;if(0==p.length&&(_=!1,console.log("AddressOK: Error: Поле для ввода почтового индекса не найдено!")),0==v.length&&(_=!1,console.log("AddressOK: Error: Поле для ввода региона не найдено!")),0==k.length&&(_=!1,console.log("AddressOK: Error: Поле для ввода района не найдено!")),0==h.length&&(_=!1,console.log("AddressOK: Error: Поле для ввода населённого пункта не найдено!")),0==y.length&&(_=!1,console.log("AddressOK: Error: Поле для ввода улицы не найдено!")),_){if("clear"==t)return i(),void f(!1);void 0==e(this).data("addressok-server-url")&&e(this).data("addressok-server-url",t);var b={};i(),p.focusout(function(){r()&&f(!0)}),v.focusout(function(){r()&&f(!1)}),k.focusout(function(){r()&&f(!1)}),h.focusout(function(){r()&&f(!1)}),y.focusout(function(){r()&&f(!1)}),f(!1)}})}}(jQuery);